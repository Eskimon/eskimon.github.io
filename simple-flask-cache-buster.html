<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Simple flask cache buster &bull; Le blog d'Eskimon</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/hljs-monokai.css" />
    <link rel="stylesheet" href="/static/css/style.css" />
    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="57x57" href="/static/images/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/static/images/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/images/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/static/images/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/static/images/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/images/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/images/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/images/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/static/images/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/images/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/static/images/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/static/images/favicon/ms-icon-144x144.png">

    <link href="https://eskimon.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog d'Eskimon Atom Feed" />
    <link href="https://eskimon.fr/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Le blog d'Eskimon RSS Feed" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-46353906-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-46353906-1');
    </script>

    <meta name="description" content="This article is gonna show how to implement a rather simple cache buster, without using query parameters" />

  <meta name="tags" content="web" />
  <meta name="tags" content="tuto" />


  <meta property="og:site_name" content="Le blog d'Eskimon">
  <meta property="og:title" content="Simple flask cache buster">
  <meta property="og:url" content="https://eskimon.fr/simple-flask-cache-buster">
  <meta property="og:language" content="fr_FR">
  <meta property="og:type" content="website">

  <meta property="twitter:domain" content="https://eskimon.fr/">
  <meta property="twitter:card" content="summary">
  <meta property="twitter:url" content="https://eskimon.fr/simple-flask-cache-buster">
  <meta property="twitter:title" content="Simple flask cache buster">
<meta property="twitter:description" content="This article is gonna show how to implement a rather simple cache buster, without using query parameters">  <meta property="twitter:site" content="SITENAME">
  <meta property="twitter:creator" content="@eskimon_fr">

  <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" />
  <meta name="DC.publisher" lang="fr" content="Le blog d'Eskimon" />
  <meta name="DC.creator" content="Eskimon" />
  <meta name="DC.type" content="text" />
  <meta name="DC.title" content="Simple flask cache buster" />
  <meta name="DC.abstract" content="Simple flask cache buster – This article is gonna show how to implement a rather simple cache buster, without using query parameters" />
  <meta name="DC.subject" lang="fr" content=" – web; tuto" />
<meta name="DC.description" lang="fr" content="This article is gonna show how to implement a rather simple cache buster, without using query parameters" />  <meta name="DC.date" content="2018-12-12T12:00:00+01:00" />
  <meta name="DC.format" content="text/html" />
  <meta name="DC.language" content="fr" />
  <meta name="DC.rights" content="CC BY" />

  <script type="application/ld+json">
    [{
        "@context": "http://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://eskimon.fr/simple-flask-cache-buster"
        },
        "headline": ""Simple flask cache buster"",
        "datePublished": "2018-12-12T12:00:00+01:00",
        "image": [
            "https://eskimon.fr/static/images/logo.png"
        ],
        "author": {
            "@type": "Person",
            "name": "Eskimon",
            "image": "https://eskimon.fr/static/images/logo.png"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Eskimon",
            "logo": {
                "@type": "ImageObject",
                "url": "https://eskimon.fr/static/images/logo.png"
            }
        },
        "description": ""This article is gonna show how to implement a rather simple cache buster, without using query parameters""
    },
    {
        "@context": "http://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "item": {
                "@id": "https://eskimon.fr/category/web",
                "name": ""Web""
            }
        }
        , {
            "@type": "ListItem",
            "position": 2,
            "item": {
                "@id": "https://eskimon.fr/simple-flask-cache-buster",
                "name": ""Simple flask cache buster""
            }
        }]
    }]
    </script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-2080155902357792",
              enable_page_level_ads: true
         });
    </script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-secondary-l40 py-0">
    <a class="navbar-brand" href="/">
        <img src="/static/images/logo.png" width="20" height="20" alt="">
        Le blog d'Eskimon
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div></div>
        <div>
            <a class="btn btn-lg text-secondary" href="https://github.com/Eskimon" rel="nofollow" title="Mon profil Github">
                <i class="fab fa-github fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://twitter.com/Eskimon_fr" rel="nofollow" title="Me suivre sur Twitter">
                <i class="fab fa-twitter fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://twitch.tv/eskimon" rel="nofollow" title="Me suivre sur Twitch">
                <i class="fab fa-twitch fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://www.youtube.com/user/Eskimon49/featured" rel="nofollow" title="Les VOD sur Youtube">
                <i class="fab fa-youtube fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://discord.gg/9SkDWft" rel="nofollow" title="Venez participer sur Discord">
                <i class="fab fa-discord fa-lg"></i>
            </a>
        </div>
        <div class="navbar-nav">
                <a class="nav-item nav-link " href="/category/arduino">Arduino</a>
                <a class="nav-item nav-link " href="/category/articles">Articles</a>
                <a class="nav-item nav-link active" href="/category/web">Web</a>
        </div>
    </div>
</nav>
    <div class="container-fluid es-verticalfill">
<div class="row">
    <!-- Sidebar -->
    <div class="col-lg-2 d-none d-lg-block sticky-top es-scrollable pt-3 px-1 bg-light es-ul-bordered" id="es-side-summary">
        <nav class="px-2" id="es-side-summary-content">
            <!-- Summary will come here -->
        </nav>
        <hr>
        <!-- Self-promo for ebook -->
        <div class="text-center">
            <h4>Ebook Arduino !</h4>
            <a href="/ebook-tutoriel-arduino.html"><img src="/images/couverture-mini.png" alt="couverture ebook" title="couverture de l'ebook"></a>
        </div>
        <hr>
        <!-- Blog side carree -->
        <div id="es-side-summary-bot-annonce" class="text-center">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:250px;height:250px"
                 data-ad-client="ca-pub-2080155902357792"
                 data-ad-slot="6115810402"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </div>
    <!-- Main content -->
    <div class="col-md-10 col-lg-8 col-xl-7 offset-md-1 offset-lg-1 offset-xl-1 d-block pt-3" id="es-content">

<div class="row" role="alert">
    <div class="ml-auto mr-auto alert alert-primary text-center">
        <a class="btn btn-lg text-secondary" href="https://twitch.tv/eskimon" rel="nofollow" title="Me suivre sur Twitch"><i class="fab fa-twitch fa-lg"></i></a>
        Rejoignez moi en <a href="htts://twitch.tv/eskimon"> live sur Twitch </a> pour apprendre le tuto Arduino autrement ! (<a href="https://twitter.com/Eskimon_fr/status/1169158978129092618">plus d'infos</a>)
        <a class="btn btn-lg text-secondary" href="https://twitch.tv/eskimon" rel="nofollow" title="Me suivre sur Twitch"><i class="fab fa-twitch fa-lg"></i></a>
    </div>
</div>

        <article>
            <!-- Leaderboard head article -->
            <ins class="adsbygoogle"
                style="display:inline-block;width:970px;height:90px"
                data-ad-client="ca-pub-2080155902357792"
                data-ad-slot="7158680773"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-white">
                    <li class="breadcrumb-item"><a href="/category/web">Web</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Simple flask cache buster</li>
                </ol>
            </nav>
            <header class="es-post-info">
                <h1 class="text-center my-4">Simple flask cache buster</h1>
            </header>
            <footer class="es-post-info pb-2 mb-2">
                <div class="row align-items-center">
                    <div class="col-auto mr-auto">
                        <span class="vcard author">
                            <a class="" href="/author/eskimon" rel="author">Eskimon</a>
                        </span>
                        ,
                        <time class="" datetime="2018-12-12T12:00:00+01:00" pubdate>
                            le mer. 12 décembre 2018
                        </time>
                            (<a href="https://eskimon.fr/simple-flask-cache-buster#disqus_thread" data-disqus-identifier="simple-flask-cache-buster">commentaires</a>)
                    </div>
                    <div class="col-auto">
                        <a class="btn btn-outline-primary btn-sm" href="/tag/web" rel="tag">web</a>
                        <a class="btn btn-outline-primary btn-sm" href="/tag/tuto" rel="tag">tuto</a>
                    </div>
                </div>
            </footer>
            <button type="button" id="sidebarCollapse" class="float-right btn btn-secondary sticky-top d-block d-lg-none">
                Sommaire
            </button>
            <!-- /.post-info -->
            <div class="entry-content">
                <p>
 Many bust caching solutions exists out there. However, most of them rely on the use of a query parameters and it has been proven many times over that it is not the best idea since browser might discard it.
</p>
<p>
 In this article, I’ll present you a solution that virtually changes the path of your static resources based on the modified timestamp of the last updated resource.
</p>
<div class="custom-block alert alert-primary">
 <div class="custom-block-body">
  <p>
   You could also use a git hash instead of the timestamp, but as my shared hosting disallow me the use of git command, I had to settle for the next best thing.
  </p>
 </div>
</div>
<h3 id="tldr">
 <a aria-hidden="true" href="#tldr">
  <span class="es-autolink-heading">
  </span>
 </a>
 TL;DR
</h3>
<p>
 In a rush? Here is the full code! Just add it to your
 <code>
  app.py
 </code>
 and you are good to go.
</p>
<div class="custom-block custom-block-spoiler">
 <div class="custom-block-body">
  <div class="hljs-code-div">
   <div class="hljs-line-numbers">
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
    <span>
    </span>
   </div>
   <pre><code class="hljs language-python"><span class="hljs-meta">@app.before_first_request</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> app.config[<span class="hljs-string">'DEBUG'</span>]:
        app.logger.info(<span class="hljs-string">'Checking static link'</span>)

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_last_modif_time</span><span class="hljs-params">()</span>:</span>
            <span class="hljs-string">"""Get the timestamp of the most recent modified file"""</span>
            path = os.path.join(os.path.dirname(os.path.realpath(__file__)), <span class="hljs-string">'static'</span>)
            files = [os.path.join(dp, f) <span class="hljs-keyword">for</span> dp, dn, filenames <span class="hljs-keyword">in</span> os.walk(path) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> filenames]
            timestamp = <span class="hljs-number">0</span>
            <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files:
                <span class="hljs-keyword">if</span> os.path.isfile(f):
                    timestamp = max(timestamp, int(os.stat(f).st_mtime))
            <span class="hljs-keyword">return</span> str(timestamp)

        last_modif_date = get_last_modif_time()

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_static_link</span><span class="hljs-params">(timestamp)</span>:</span>
            <span class="hljs-string">"""
            Check that we have a link to the static folder
            The link should be &lt;timestamp -&gt; .&gt; (ln -s . timestamp)
            inside static folder
            """</span>
            path = os.path.join(os.path.dirname(os.path.realpath(__file__)), <span class="hljs-string">'static'</span>)
            <span class="hljs-comment"># Unlink previous links</span>
            files = os.listdir(path)
            <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files:
                <span class="hljs-keyword">if</span> os.path.islink(os.path.join(path, f)):
                    <span class="hljs-keyword">if</span> os.readlink(os.path.join(path, f)) == path:
                        app.logger.info(<span class="hljs-string">'Remove old link {}'</span>.format(f))
                        os.unlink(os.path.join(path, f))
            <span class="hljs-comment"># Create the newest link</span>
            app.logger.info(<span class="hljs-string">'Create link to static {}'</span>.format(os.path.join(path, timestamp)))
            os.symlink(path, os.path.join(path, timestamp))

        check_static_link(last_modif_date)

        <span class="hljs-comment"># Cache Buster (return static url amended with last timestamp)</span>
<span class="hljs-meta">        @app.url_defaults</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">static_cache_buster</span><span class="hljs-params">(endpoint, values)</span>:</span>
            <span class="hljs-keyword">if</span> endpoint <span class="hljs-keyword">in</span> <span class="hljs-string">'static'</span>:
                values[<span class="hljs-string">'filename'</span>] = os.path.join(last_modif_date, values[<span class="hljs-string">'filename'</span>])
</code></pre>
  </div>
 </div>
</div>
<h3 id="detailed-version">
 <a aria-hidden="true" href="#detailed-version">
  <span class="es-autolink-heading">
  </span>
 </a>
 Detailed version
</h3>
<p>
 For those of view how wants to know more, here are some details.
</p>
<p>
 To avoid browser caching of outdated resources, we need to change the path of the resource. The main idea behind all this code will be to generate a path like
 <code>
  /static/&lt;last_timestamp&gt;/css/style.css
 </code>
 for example. The important part here is the
 <code>
  &lt;last_timestamp&gt;/
 </code>
 fragment. This piece of string is gonna be changed everytime we reload the flask server and a static resource has been updated.
</p>
<h4 id="1-finding-the-last-timestamp">
 <a aria-hidden="true" href="#1-finding-the-last-timestamp">
  <span class="es-autolink-heading">
  </span>
 </a>
 1. Finding the last timestamp
</h4>
<p>
 First thing to do is to identify what is the timestamp of the most recently modified resource. To do so, we will use the
 <code>
  os.walk()
 </code>
 function to get all the files in the
 <code>
  static/
 </code>
 folder. Then, with
 <code>
  os.stat()
 </code>
 we will get the last modified timestamp.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_last_modif_time</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Get the timestamp of the most recent modified file"""</span>
    path = os.path.join(os.path.dirname(os.path.realpath(__file__)), <span class="hljs-string">'static'</span>)
    files = [os.path.join(dp, f) <span class="hljs-keyword">for</span> dp, dn, filenames <span class="hljs-keyword">in</span> os.walk(path) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> filenames]
    timestamp = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files:
        <span class="hljs-keyword">if</span> os.path.isfile(f):
            timestamp = max(timestamp, int(os.stat(f).st_mtime))
    <span class="hljs-keyword">return</span> str(timestamp)

last_modif_date = get_last_modif_time()
</code></pre>
</div>
<h4 id="2-creating-the-new-path">
 <a aria-hidden="true" href="#2-creating-the-new-path">
  <span class="es-autolink-heading">
  </span>
 </a>
 2. Creating the new path
</h4>
<p>
 As mentionned before, we need to change path from
 <code>
  /static/css/style.css
 </code>
 to
 <code>
  /static/&lt;last_timestamp&gt;/css/style.css
 </code>
 . In order to do that without moving around all the files, we simply create a symbolic link named
 <code>
  last_timestamp
 </code>
 and pointing to its current place. Hence we get the following structure:
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-text">/home/eskimon/foo/bar/twittorama/static$ tree

.
├── 1542798662 -&gt; /home/eskimon/foo/bar/twittorama/static
├── css
│   └── style.css
├── images
└── js
    ├── gallery.js
    └── vuegallery.js
</code></pre>
</div>
<p>
 The function to do this need also to remove former existing link to avoid spamming the folder with new links everytime we update the site:
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_static_link</span><span class="hljs-params">(timestamp)</span>:</span>
    <span class="hljs-string">"""
    Check that we have a link to the static folder
    The link should be &lt;timestamp -&gt; .&gt; (ln -s . timestamp)
    inside static folder
    """</span>
    path = os.path.join(os.path.dirname(os.path.realpath(__file__)), <span class="hljs-string">'static'</span>)
    <span class="hljs-comment"># Unlink previous links</span>
    files = os.listdir(path)
    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files:
        <span class="hljs-keyword">if</span> os.path.islink(os.path.join(path, f)):
            <span class="hljs-keyword">if</span> os.readlink(os.path.join(path, f)) == path:
                app.logger.info(<span class="hljs-string">'Remove old link {}'</span>.format(f))
                os.unlink(os.path.join(path, f))
    <span class="hljs-comment"># Create the newest link</span>
    app.logger.info(<span class="hljs-string">'Create link to static {}'</span>.format(os.path.join(path, timestamp)))
    os.symlink(path, os.path.join(path, timestamp))

check_static_link(last_modif_date)
</code></pre>
</div>
<h4 id="3-redirecting-request-to-static">
 <a aria-hidden="true" href="#3-redirecting-request-to-static">
  <span class="es-autolink-heading">
  </span>
 </a>
 3. Redirecting request to static
</h4>
<p>
 Last thing to do is to update the
 <code>
  url_for
 </code>
 behavior for the templating. We will use the decorator
 <code>
  @app.url_defaults
 </code>
 in order to do that. The behavior is simple, everytime a request is made on the endpoint
 <code>
  static
 </code>
 , then the filename must be changed from
 <code>
  foo/bar/static/filename/path.css
 </code>
 to
 <code>
  foo/bar/static/&lt;timestamp&gt;/filename/path.css
 </code>
 . Because we now have a symbolic link, the path can be resolved.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-python"><span class="hljs-comment"># Cache Buster (return static url amended with last timestamp)</span>
<span class="hljs-meta">@app.url_defaults</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">static_cache_buster</span><span class="hljs-params">(endpoint, values)</span>:</span>
    <span class="hljs-keyword">if</span> endpoint <span class="hljs-keyword">in</span> <span class="hljs-string">'static'</span>:
        values[<span class="hljs-string">'filename'</span>] = os.path.join(last_modif_date, values[<span class="hljs-string">'filename'</span>])
</code></pre>
</div>
<h4 id="4-wrapping-it-to-execute-only-once">
 <a aria-hidden="true" href="#4-wrapping-it-to-execute-only-once">
  <span class="es-autolink-heading">
  </span>
 </a>
 4. Wrapping it to execute only once
</h4>
<p>
 Last but not least, all this behavior must be executing only before the first request. The link should not be destroyed and recreate everytime a user request a page!
</p>
<p>
 The solution is simply to wrap all our code in a function decorated with
 <code>
  @app.before_first_request
 </code>
 .
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-python"><span class="hljs-meta">@app.before_first_request</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># All the code we made so far!</span>
</code></pre>
</div>
<h3 id="conclusion">
 <a aria-hidden="true" href="#conclusion">
  <span class="es-autolink-heading">
  </span>
 </a>
 Conclusion
</h3>
<p>
 There you go, a simple yet efficient cache busting solution that doesn’t involve any query parameters!
</p>
            </div>
            <!-- /.entry-content -->
            <hr>
            <div class="text-center">
                <img class="es-licence-pic" src="/static/images/CC BY.png" alt="Licence CC BY" title="Article sous licence CC BY">
            </div>
            <div class="my-3 text-center">
                <a class="btn btn-outline-dark mx-1" href="https://twitter.com/share?url=https://eskimon.fr/simple-flask-cache-buster&amp;text=Simple flask cache buster - https://eskimon.fr/simple-flask-cache-buster" rel="nofollow" title="Partager cet article sur Twitter" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-twitter fa-lg"></i>
                </a>
                <a class="btn btn-outline-dark mx-1" href="https://www.facebook.com/sharer.php?u=https://eskimon.fr/simple-flask-cache-buster&amp;t=Simple flask cache buster - https://eskimon.fr/simple-flask-cache-buster" rel="nofollow" title="Partager cet article sur Facebook" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-facebook-f fa-lg"></i>
                </a>
                <a class="btn btn-outline-dark mx-1" href="https://plus.google.com/share?url=https://eskimon.fr/simple-flask-cache-buster&amp;hl=fr" rel="nofollow" title="Partager cet article sur Google +" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-google-plus fa-lg"></i>
                </a>
                <!--<a class="btn btn-outline-dark mx-1" href="http://sharetodiaspora.github.io/?url=https://eskimon.fr/simple-flask-cache-buster&amp;title=Simple flask cache buster - https://eskimon.fr/simple-flask-cache-buster" rel="nofollow"  title="Partager cet article sur Diaspora" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-google-plus fa-lg"></i>
                </a>-->
                <a class="btn btn-outline-dark mx-1" href="mailto:?subject=Simple flask cache buster&amp;body=https://eskimon.fr/simple-flask-cache-buster"rel="nofollow" title="Partager cet article par email" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="far fa-envelope fa-lg"></i>
                </a>
            </div>
            <hr>
            <div class="text-center">
                <!-- billboard horizontal fin article -->
                <ins class="adsbygoogle" style="display:inline-block;width:970px;height:250px" data-ad-client="ca-pub-2080155902357792" data-ad-slot="6471099302"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
            <!-- disqus start -->
            <div id="disqus_thread"></div>
            <script>
                var disqus_config = function () {
                    this.page.url = 'https://eskimon.fr/simple-flask-cache-buster';
                    this.page.identifier = 'simple-flask-cache-buster';
                    this.page.title = 'Simple flask cache buster';
                };
                (function () { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = 'https://eskimon-fr.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the
                <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
            </noscript>
            <!-- disqus end -->
        </article>
    </div>
    <div class="d-none d-xl-block col-xl-1 offset-xl-1 px-0">
        <div class="d-flex flex-column justify-content-around align-items-end h-100" id="es-right-ad-block">
            <!-- Pub ajouté auto -->
        </div>
    </div>
</div>
    </div>
<footer class="container-fluid bg-dark small text-white px-3">
<div class="row">
    <div class="col align-self-center">
        © Eskimon -
        Blog propulsé par <a class="bold text-white" href="https://blog.getpelican.com/" rel="nofollow">Pelican</a> -
        Thème fait maison
    </div>
    <div class="col align-self-end text-right">
        <a class="btn btn-lg text-light" href="https://github.com/Eskimon" rel="nofollow" title="Mon profil Github">
            <i class="fab fa-github fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://twitter.com/Eskimon_fr" rel="nofollow" title="Me suivre sur Twitter">
            <i class="fab fa-twitter fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://twitch.tv/eskimon" rel="nofollow" title="Me suivre sur Twitch">
            <i class="fab fa-twitch fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://www.youtube.com/user/Eskimon49/featured" rel="nofollow" title="Les VOD sur Youtube">
            <i class="fab fa-youtube fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://discord.gg/9SkDWft" rel="nofollow" title="Venez participer sur Discord">
            <i class="fab fa-discord fa-lg"></i>
        </a>
    </div>
  </div>
</footer>
    <!-- For formula -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- Font awesome -->
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
    <!-- JQuery first -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- For tooltips -->
    <script>$(function () {  $('[data-toggle="tooltip"]').tooltip()})</script>
    <script src="/static/js/my-scripts.js"></script>
<script>
function create_side_summary() {
    // Duplicate summary
    var main_summary = $('#sommaire').next();
    if(main_summary.length === 0)
        return
    var side_summary = main_summary.clone();
    side_summary.addClass('pl-0');
    var all_p = side_summary.find('p');
    all_p.contents().unwrap();
    var all_li = side_summary.find('li');
    all_li.addClass('pl-1');

    // scrollspy - in
    side_summary.attr('id', 'es-side-summary-mainlist');
    //side_summary.addClass('nav');
    //all_li.addClass('nav-item');
    var all_a = side_summary.find('a');
    all_a.addClass('nav-link');
    var all_ul = side_summary.find('ul');
    all_ul.addClass('pl-1');
    $('body').scrollspy({ target: '#es-side-summary-mainlist' });
    // scrollspy - out

    var summary_title = document.createElement("h4");
    summary_title.className = 'navbar-brand';
    summary_title.innerHTML = 'Sommaire';
    $(summary_title).prependTo('#es-side-summary-content');
    side_summary.appendTo('#es-side-summary-content');
    main_summary.addClass('es-subul-collapse');
}

function generate_spoilers() {
    all_secret = $('.custom-block-spoiler');
    all_secret.each(function( index ) {
        let content = $(this).html();
        $(this).html('');
        $(this).addClass('card');
        var headerText = document.createElement("button");
        var cardHeader = document.createElement("div");
        var cardBodyWrapper = document.createElement("div");
        var cardBody = document.createElement("div");
        $(headerText).text('Contenu masqué, cliquez pour afficher');
        $(headerText).addClass('btn btn-link btn-sm');
        $(headerText).attr('data-toggle', 'collapse');
        $(headerText).attr('data-target', '#collapse-' + index);
        $(headerText).attr('aria-controls', 'collapse-' + index);
        $(headerText).attr('aria-expanded', 'false');
        $(cardHeader).append(headerText);
        $(cardHeader).addClass('card-header');
        $(cardHeader).attr('id', 'spoiler-' + index);
        $(cardBody).html(content);
        $(cardBody).addClass('card-body');
        $(cardBodyWrapper).append(cardBody);
        $(cardBodyWrapper).addClass('collapse hide');
        $(cardBodyWrapper).attr('id', 'collapse-' + index)
        $(cardBodyWrapper).attr('aria-labelledby', 'spoiler-' + index)
        $(this).prepend(cardHeader);
        $(this).append(cardBodyWrapper);
    });

    $('.collapse').collapse({toggle: false});
}

function load_extra_ads() {
    return;
    // Load right side blocks
    var sidebar = $('#es-right-ad-block');
    var n_height = Math.floor(sidebar.height() / 2000);
    for (i = 0; i < n_height; i++) {
        var frag = document.createDocumentFragment();
        var newAdBlock = document.createElement("div");
        var block1 = document.createElement("ins");
        var block2 = document.createElement("script");

        block1.innerHTML = '<ins class="adsbygoogle" ' +
            'style="display:inline-block;width:120px;height:600px" ' +
            'data-ad-client="ca-pub-2080155902357792" ' +
            'data-ad-slot="4023722026"></ins>';
        block2.innerHTML = '(adsbygoogle = window.adsbygoogle || []).push({});';

        $(newAdBlock).append(block1);
        $(newAdBlock).append(block2);
        $(frag).append(newAdBlock);

        $(sidebar).append(frag);
    }

    // Load in feed blocks (above every h3)
    var frag = document.createDocumentFragment();
    var newAdBlock = document.createElement("div");
    var block1 = document.createElement("ins");
    var block2 = document.createElement("script");
    block1.innerHTML = '<ins class="adsbygoogle"' +
    'style = "display:inline-block;width:970px;height:90px"' +
    'data - ad - client="ca-pub-2080155902357792"' +
    'data - ad - slot="7100712740" ></ins >'
    block2.innerHTML = '(adsbygoogle = window.adsbygoogle || []).push({});';
    $(newAdBlock).append(block1);
    $(newAdBlock).append(block2);
    newAdBlock.className = 'my-3 text-center';
    $(frag).append(newAdBlock);
    var titles = $('.entry-content h3').slice(1);
    $(frag).insertBefore(titles);
}

$(document).ready(function () {

    create_side_summary();
    generate_spoilers();
    load_extra_ads();

    // when opening the sidebar
    $('#sidebarCollapse').on('click', function () {
        // open sidebar
        $('#es-side-summary').removeClass('d-none');
        $('#es-content').addClass('d-none');
        $('#sidebarCollapse').removeClass('sticky-top');
    });

    // if dismiss or overlay was clicked
    $('#es-side-summary').on('click', function () {
      // hide the sidebar
      $('#es-side-summary').addClass('d-none');
      $('#es-content').removeClass('d-none');
      $('#sidebarCollapse').addClass('sticky-top');
    });
});
</script>

<script id="dsq-count-scr" src="//eskimon-fr.disqus.com/count.js" async></script>
</body>

</html>