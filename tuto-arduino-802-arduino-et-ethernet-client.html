<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Arduino et Ethernet : client &bull; Le blog d'Eskimon</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/hljs-monokai.css" />
    <link rel="stylesheet" href="/static/css/style.css" />
    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="57x57" href="/static/images/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/static/images/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/images/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/static/images/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/static/images/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/images/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/images/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/images/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/static/images/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/images/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/static/images/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/static/images/favicon/ms-icon-144x144.png">

    <link href="https://eskimon.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog d'Eskimon Atom Feed" />
    <link href="https://eskimon.fr/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Le blog d'Eskimon RSS Feed" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-46353906-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-46353906-1');
    </script>


    <meta name="description" content="Commençons la découverte du shield Ethernet en l'utilisant comme client et aller lire des pages/services web avec notre Arduino." />

  <meta name="tags" content="arduino" />
  <meta name="tags" content="tuto" />


  <meta property="og:site_name" content="Le blog d'Eskimon">
  <meta property="og:title" content="Arduino et Ethernet : client">
  <meta property="og:url" content="https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client">
  <meta property="og:language" content="fr_FR">
  <meta property="og:type" content="website">

  <meta property="twitter:domain" content="https://eskimon.fr/">
  <meta property="twitter:card" content="summary">
  <meta property="twitter:url" content="https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client">
  <meta property="twitter:title" content="Arduino et Ethernet : client">
<meta property="twitter:description" content="Commençons la découverte du shield Ethernet en l'utilisant comme client et aller lire des pages/services web avec notre Arduino.">  <meta property="twitter:site" content="SITENAME">
  <meta property="twitter:creator" content="@eskimon_fr">

  <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" />
  <meta name="DC.publisher" lang="fr" content="Le blog d'Eskimon" />
  <meta name="DC.creator" content="Eskimon" />
  <meta name="DC.type" content="text" />
  <meta name="DC.title" content="Arduino et Ethernet : client" />
  <meta name="DC.abstract" content="Arduino et Ethernet : client – Commençons la découverte du shield Ethernet en l'utilisant comme client et aller lire des pages/services web avec notre Arduino." />
  <meta name="DC.subject" lang="fr" content="Arduino/H - Internet of Things : Arduino sur Internet – arduino; tuto" />
<meta name="DC.description" lang="fr" content="Commençons la découverte du shield Ethernet en l'utilisant comme client et aller lire des pages/services web avec notre Arduino." />  <meta name="DC.date" content="2015-03-26T14:22:00+01:00" />
  <meta name="DC.format" content="text/html" />
  <meta name="DC.language" content="fr" />
  <meta name="DC.rights" content="CC BY-NC-SA" />

  <script type="application/ld+json">
    [{
        "@context": "http://schema.org",
        "@type": "Article",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client"
        },
        "headline": ""Arduino et Ethernet : client"",
        "datePublished": "2015-03-26T14:22:00+01:00",
        "image": [
            "https://eskimon.fr/static/images/logo.png"
        ],
        "author": {
            "@type": "Person",
            "name": "Eskimon",
            "image": "https://eskimon.fr/static/images/logo.png"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Eskimon",
            "logo": {
                "@type": "ImageObject",
                "url": "https://eskimon.fr/static/images/logo.png"
            }
        },
        "description": ""Commen\u00e7ons la d\u00e9couverte du shield Ethernet en l\u0027utilisant comme client et aller lire des pages/services web avec notre Arduino.""
    },
    {
        "@context": "http://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "item": {
                "@id": "https://eskimon.fr/category/arduino",
                "name": ""Arduino""
            }
        }
        , {
            "@type": "ListItem",
            "position": 2,
            "item": {
                "@id": "https://eskimon.fr/subcategory/arduino/h-internet-of-things-arduino-sur-internet",
                "name": ""H - Internet of Things : Arduino sur Internet""
            }
        }
        , {
            "@type": "ListItem",
            "position": 3,
            "item": {
                "@id": "https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client",
                "name": ""Arduino et Ethernet : client""
            }
        }]
    }]
    </script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-2080155902357792",
              enable_page_level_ads: true
         });
    </script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-secondary-l40 py-0">
    <a class="navbar-brand" href="/">
        <img src="/static/images/logo.png" width="20" height="20" alt="">
        Le blog d'Eskimon
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div></div>
        <div>
            <a class="btn btn-lg text-secondary" href="https://github.com/Eskimon" rel="nofollow" title="Mon profil Github">
                <i class="fab fa-github fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://twitter.com/Eskimon_fr" rel="nofollow" title="Me suivre sur Twitter">
                <i class="fab fa-twitter fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://twitch.tv/eskimon" rel="nofollow" title="Me suivre sur Twitch">
                <i class="fab fa-twitch fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://www.youtube.com/user/Eskimon49/featured" rel="nofollow" title="Les VOD sur Youtube">
                <i class="fab fa-youtube fa-lg"></i>
            </a>
            <a class="btn btn-lg text-secondary" href="https://discord.gg/9SkDWft" rel="nofollow" title="Venez participer sur Discord">
                <i class="fab fa-discord fa-lg"></i>
            </a>
        </div>
        <div class="navbar-nav">
                <a class="nav-item nav-link active" href="/category/arduino">Arduino</a>
                <a class="nav-item nav-link " href="/category/articles">Articles</a>
                <a class="nav-item nav-link " href="/category/web">Web</a>
        </div>
    </div>
</nav>
    <div class="container-fluid es-verticalfill">
<div class="row">
    <!-- Sidebar -->
    <div class="col-lg-2 d-none d-lg-block sticky-top es-scrollable pt-3 px-1 bg-light es-ul-bordered" id="es-side-summary">
        <nav class="px-2" id="es-side-summary-content">
            <!-- Summary will come here -->
        </nav>
        <hr>
        <!-- Self-promo for ebook -->
        <div class="text-center">
            <h4>Ebook Arduino !</h4>
            <a href="/ebook-tutoriel-arduino.html"><img src="/images/couverture-mini.png" alt="couverture ebook" title="couverture de l'ebook"></a>
        </div>
        <hr>
        <!-- Blog side carree -->
        <div id="es-side-summary-bot-annonce" class="text-center">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:250px;height:250px"
                 data-ad-client="ca-pub-2080155902357792"
                 data-ad-slot="6115810402"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </div>
    <!-- Main content -->
    <div class="col-md-10 col-lg-8 col-xl-7 offset-md-1 offset-lg-1 offset-xl-1 d-block pt-3" id="es-content">

        <div class="row">
            <div class="col ml-auto mr-auto text-center">
                <div class="custom-block alert alert-info">
                    <div class="custom-block-body">
                        <p>
                        Vous avez une question ? Une remarque ? N'hésitez pas à venir en parler dans le chat si je suis en cours de diffusion !
                        </p>
                        <iframe src="https://player.twitch.tv/?channel=eskimon&amp;muted=true&amp;autoplay=true&parent=eskimon.fr" scrolling="false" allowfullscreen="true" width="450" height="260" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <article>
            <!-- Leaderboard head article -->
            <!--
            <ins class="adsbygoogle"
                style="display:inline-block;width:970px;height:90px"
                data-ad-client="ca-pub-2080155902357792"
                data-ad-slot="7158680773"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
            -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-white">
                    <li class="breadcrumb-item"><a href="/category/arduino">Arduino</a></li>
                        <li class="breadcrumb-item"><a href="/subcategory/arduino/h-internet-of-things-arduino-sur-internet">H - Internet of Things : Arduino sur Internet</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Arduino et Ethernet : client</li>
                </ol>
            </nav>
            <header class="es-post-info">
                <h1 class="text-center my-4">Arduino et Ethernet : client</h1>
            </header>
            <footer class="es-post-info pb-2 mb-2">
                <div class="row align-items-center">
                    <div class="col-auto mr-auto">
                        <span class="vcard author">
                            <a class="" href="/author/eskimon" rel="author">Eskimon</a>
                        </span>
                        ,
                        <time class="" datetime="2015-03-26T14:22:00+01:00" pubdate>
                            le jeu. 26 mars 2015
                        </time>
                    </div>
                    <div class="col-auto">
                        <a class="btn btn-outline-primary btn-sm" href="/tag/arduino" rel="tag">arduino</a>
                        <a class="btn btn-outline-primary btn-sm" href="/tag/tuto" rel="tag">tuto</a>
                    </div>
                </div>
            </footer>
            <button type="button" id="sidebarCollapse" class="float-right btn btn-secondary sticky-top d-block d-lg-none">
                Sommaire
            </button>
            <!-- /.post-info -->
            <div class="entry-content">
                <p>
 Commençons doucement à découvrir ce shield en utilisant notre Arduino comme
 <strong>
  client
 </strong>
 .
Dans ce chapitre, nous allons découvrir comment faire en sorte que notre Arduino aille interroger un site internet pour obtenir une information de sa part.
</p>
<div class="custom-block alert alert-primary">
 <div class="custom-block-body">
  <p>
   Ici nous allons interroger un site internet, mais cela aurait très bien pu être un autre service, sur un autre port (vous allez comprendre)
  </p>
 </div>
</div>
<p>
 Afin de bien comprendre, je vous propose tout d’abord quelques explications sur le protocole HTTP et comment se passe un échange de données (requête + réponse).
</p>
<p>
 Ensuite, nous verrons comment mettre en œuvre le shield et faire en sorte qu’il puisse accéder au monde extérieur.
</p>
<p>
 Enfin, nous mettrons tout en œuvre pour faire une simple requête sur un moteur de recherche.
</p>
<p>
 Pour terminer, je vous propose un petit exercice qui permettra de voir un cas d’utilisation : le "monitoring" d’un serveur.
</p>
<h3 id="sommaire">
 <a aria-hidden="true" href="#sommaire">
  <span class="es-autolink-heading">
  </span>
 </a>
 Sommaire
</h3>
<ul>
 <li>
  <p>
   <a href="#client-et-requêtes-http">
    Client et requêtes HTTP
   </a>
  </p>
  <ul>
   <li>
    <a href="#un-client-ça-fait-quoi">
     Un client, ça fait quoi ?
    </a>
   </li>
   <li>
    <p>
     <a href="#une-requête-http-cest-quoi">
      Une requête HTTP, c’est quoi ?
     </a>
    </p>
    <ul>
     <li>
      <a href="#Émission">
       Émission
      </a>
     </li>
     <li>
      <a href="#réception">
       Réception
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li>
  <p>
   <a href="#utilisation-du-shield-comme-client">
    Utilisation du shield comme client
   </a>
  </p>
  <ul>
   <li>
    <a href="#préparation-minimale">
     Préparation minimale
    </a>
   </li>
   <li>
    <p>
     <a href="#démarrer-le-shield">
      Démarrer le shield
     </a>
    </p>
    <ul>
     <li>
      <a href="#le-dhcp">
       le DHCP
      </a>
     </li>
    </ul>
   </li>
   <li>
    <p>
     <a href="#envoyer-une-requête">
      Envoyer une requête
     </a>
    </p>
    <ul>
     <li>
      <a href="#requête-simple">
       Requête simple
      </a>
     </li>
     <li>
      <a href="#requête-avec-paramètre">
       Requête avec paramètre
      </a>
     </li>
    </ul>
   </li>
   <li>
    <p>
     <a href="#lire-une-réponse">
      Lire une réponse
     </a>
    </p>
    <ul>
     <li>
      <a href="#code-complet">
       Code complet
      </a>
     </li>
    </ul>
   </li>
   <li>
    <p>
     <a href="#faire-des-requêtes-en-continu">
      Faire des requêtes en continu
     </a>
    </p>
    <ul>
     <li>
      <a href="#le-code-complet">
       Le code complet
      </a>
     </li>
    </ul>
   </li>
   <li>
    <p>
     <a href="#lintérêt-dun-client">
      L’intérêt d’un client
     </a>
    </p>
    <ul>
     <li>
      <a href="#télécharger-une-configuration">
       Télécharger une configuration
      </a>
     </li>
     <li>
      <a href="#enregistrer-des-données-en-ligne">
       Enregistrer des données en ligne
      </a>
     </li>
     <li>
      <a href="#sûrement-plein-dautres-choses">
       Sûrement plein d’autres choses !
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li>
  <p>
   <a href="#exercice-lire-luptime-de-eskimonfr">
    Exercice, lire l’uptime de Eskimon.fr
   </a>
  </p>
  <ul>
   <li>
    <a href="#consigne">
     Consigne
    </a>
   </li>
  </ul>
 </li>
</ul>
<h3 id="client-et-requêtes-http">
 <a aria-hidden="true" href="#client-et-requêtes-http">
  <span class="es-autolink-heading">
  </span>
 </a>
 Client et requêtes HTTP
</h3>
<p>
 Faisons un petit retour étendu sur la notion de client et surtout découvrons plus en détail en quoi consiste exactement une requête HTTP.
</p>
<h4 id="un-client-ça-fait-quoi">
 <a aria-hidden="true" href="#un-client-ça-fait-quoi">
  <span class="es-autolink-heading">
  </span>
 </a>
 Un client, ça fait quoi ?
</h4>
<p>
 Le rôle du client est finalement assez simple. Son but sera d’aller chercher des informations pour les afficher à un utilisateur ou effectuer une action particulière. D’une manière générale, le client sera celui qui traite l’information que le serveur envoie.
</p>
<p>
 Prenons l’exemple du navigateur web. C’est un
 <em>
  client
 </em>
 . Lorsque vous l’utilisez, vous allez générer des
 <em>
  requêtes
 </em>
 vers des serveurs et ces derniers vont ensuite renvoyer un tas d’informations (la page web). Le navigateur va alors les traiter pour vous les afficher sous une forme agréable et prévue par le développeur web.
</p>
<p>
 Finalement, c’est simple d’être client, ça consiste juste à demander des choses et attendre qu’elles arrivent
 <img alt=":)" class="smiley" src="./static/smileys/smile.png"/>
 !
</p>
<p>
 Les termes "client" et "serveur" (et même "requête") sont d’ailleurs très bien choisis car ils illustrent très bien les mêmes rôles que leur équivalent "dans la vraie vie".
</p>
<h4 id="une-requête-http-cest-quoi">
 <a aria-hidden="true" href="#une-requête-http-cest-quoi">
  <span class="es-autolink-heading">
  </span>
 </a>
 Une requête HTTP, c’est quoi ?
</h4>
<p>
 Des requêtes HTTP il en existe de plusieurs types. Les plus classiques sont sûrement les GET et les POST, mais on retrouve aussi les PUT, DELETE, HEAD… Pour faire simple, nous allons uniquement nous intéresser à la première car c’est celle qui est utilisée la plupart du temps !
</p>
<h5 id="Émission">
 <a aria-hidden="true" href="#Émission">
  <span class="es-autolink-heading">
  </span>
 </a>
 Émission
</h5>
<p>
 Dans la spécification du protocole HTTP, on apprend que GET nous permet de demander une ressource en lecture seule. On aura simplement besoin de spécifier une page cible et ensuite le serveur HTTP de cette page nous renverra la ressource ou un code d’erreur en cas de problème. On peut passer des arguments/options à la fin de l’adresse que l’on interroge pour demander des choses plus particulières au serveur.
</p>
<p>
 Par exemple, si vous êtes sur la page d’accueil de Google et que vous faites une recherche sur "Arduino", votre navigateur fera la requête suivante :
 <code>
  GET /search?q=arduino HTTP/1.0
 </code>
 . Il interroge donc la page principale "/" (racine) et envoie l’argument "search?q=arduino". Le reste définit le protocole utilisé.
</p>
<h5 id="réception">
 <a aria-hidden="true" href="#réception">
  <span class="es-autolink-heading">
  </span>
 </a>
 Réception
</h5>
<p>
 Une fois la requête faite, le serveur interrogé va vous renvoyer une réponse. Cette réponse peut être découpée en deux choses : l’en-tête (header) et le contenu. On pourrait comparer cela à un envoi de colis. L’en-tête possèderait les informations sur le colis (destinataires, etc.) et le contenu est ce qui est à l’intérieur du colis.
</p>
<p>
 Typiquement, dans une réponse minimaliste, on lira les informations suivantes :
</p>
<ul>
 <li>
  Le code de réponse de la requête (200 si tout s’est bien passé) ;
 </li>
 <li>
  Le type MIME du contenu renvoyé (
  <code>
   text/html
  </code>
  dans le cas d’une page web) ;
 </li>
 <li>
  Une ligne blanche/vide ;
 </li>
 <li>
  Le contenu.
 </li>
</ul>
<p>
 Les deux premières lignes font partie du header, puis après viendra le contenu.
</p>
<p>
 Si l’on veut chercher des informations, en général on le fera dans le contenu.
</p>
<h3 id="utilisation-du-shield-comme-client">
 <a aria-hidden="true" href="#utilisation-du-shield-comme-client">
  <span class="es-autolink-heading">
  </span>
 </a>
 Utilisation du shield comme client
</h3>
<p>
 Maintenant que l’on en sait un peu plus, on va pouvoir faire des requêtes et aller interroger le monde…
</p>
<h4 id="préparation-minimale">
 <a aria-hidden="true" href="#préparation-minimale">
  <span class="es-autolink-heading">
  </span>
 </a>
 Préparation minimale
</h4>
<p>
 Pour commencer, il va falloir configurer notre module Ethernet pour qu’il puisse travailler correctement. Pour cela, il va falloir lui donner une adresse MAC et une adresse IP (qui peut être automatique, nous y reviendrons). On va utiliser 4 variables différentes :
</p>
<ul>
 <li>
  Un tableau de
  <code>
   byte
  </code>
  (ou char) pour les 6 octets de l’adresse MAC ;
 </li>
 <li>
  Un objet
  <code>
   IPAddress
  </code>
  avec l’adresse IP que l’on assigne au module ;
 </li>
 <li>
  Un objet
  <code>
   EthernetClient
  </code>
  qui nous servira à faire la communication ;
 </li>
 <li>
  Une chaîne de caractères représentant le nom du serveur à interroger.
 </li>
</ul>
<div class="custom-block alert alert-primary">
 <div class="custom-block-body">
  <p>
   L’adresse MAC doit normalement être écrite sur un autocollant au dos de votre shield (sinon inventez-en une !)
  </p>
 </div>
</div>
<p>
 De manière programmatoire, on aura les variables ci-dessous.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// Ces deux bibliothèques sont indispensables pour le shield</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Ethernet.h&gt;</span></span>

<span class="hljs-comment">// L'adresse MAC du shield</span>
byte mac[] = { <span class="hljs-number">0x90</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x0E</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0x7E</span> };
<span class="hljs-comment">// L'adresse IP que prendra le shield</span>
<span class="hljs-function">IPAddress <span class="hljs-title">ip</span><span class="hljs-params">(<span class="hljs-number">192</span>,<span class="hljs-number">168</span>,<span class="hljs-number">0</span>,<span class="hljs-number">143</span>)</span></span>;
<span class="hljs-comment">// L'objet qui nous servira à la communication</span>
EthernetClient client;
<span class="hljs-comment">// Le serveur à interroger</span>
<span class="hljs-keyword">char</span> serveur[] = <span class="hljs-string">"leserveur.com"</span>
</code></pre>
</div>
<h4 id="démarrer-le-shield">
 <a aria-hidden="true" href="#démarrer-le-shield">
  <span class="es-autolink-heading">
  </span>
 </a>
 Démarrer le shield
</h4>
<p>
 Maintenant que nous avons nos variables, nous allons pouvoir démarrer notre shield dans le
 <code>
  setup()
 </code>
 . Pour cela, il suffira d’appeler une fonction bien nommée :
 <code>
  begin()
 </code>
 , eh oui, comme pour la voie série ! Cette fonction prendra deux paramètres, l’adresse MAC et l’adresse IP à utiliser. C’est aussi simple que cela !
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// Ces deux bibliothèques sont indispensables pour le shield</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Ethernet.h&gt;</span></span>

<span class="hljs-comment">// L'adresse MAC du shield</span>
byte mac[] = { <span class="hljs-number">0x90</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x0E</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0x7E</span> };
<span class="hljs-comment">// L'adresse IP que prendra le shield</span>
<span class="hljs-function">IPAddress <span class="hljs-title">ip</span><span class="hljs-params">(<span class="hljs-number">192</span>,<span class="hljs-number">168</span>,<span class="hljs-number">0</span>,<span class="hljs-number">143</span>)</span></span>;
<span class="hljs-comment">// L'objet qui nous servira à la communication</span>
EthernetClient client;
<span class="hljs-comment">// Le serveur à interroger</span>
<span class="hljs-keyword">char</span> serveur[] = <span class="hljs-string">"perdu.com"</span>

<span class="hljs-keyword">void</span> setup() {
  <span class="hljs-comment">// On demarre la voie série pour déboguer</span>
  Serial.begin(<span class="hljs-number">9600</span>);

  <span class="hljs-comment">// On démarre le shield Ethernet</span>
  Ethernet.begin(mac, ip);
  <span class="hljs-comment">// Donne une seconde au shield pour s'initialiser</span>
  delay(<span class="hljs-number">1000</span>);
}
</code></pre>
</div>
<p>
 Simple non ?
</p>
<h5 id="le-dhcp">
 <a aria-hidden="true" href="#le-dhcp">
  <span class="es-autolink-heading">
  </span>
 </a>
 le DHCP
</h5>
<p>
 Si vous bricolez à domicile, il est fort probable que vous soyez en train d’utiliser un routeur ou votre box internet. Bien souvent, ces derniers ont par défaut la fonction DHCP activée. Cette technologie permet de donner une adresse IP automatiquement à tous les équipements qui se connectent au réseau. Ainsi, plus besoin de le faire manuellement !
</p>
<p>
 Du coup, on peut faire évoluer notre script d’initialisation pour prendre en compte cela.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// Ces deux bibliothèques sont indispensables pour le shield</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Ethernet.h&gt;</span></span>

<span class="hljs-comment">// L'adresse MAC du shield</span>
byte mac[] = { <span class="hljs-number">0x90</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x0E</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0x7E</span> };
<span class="hljs-comment">// L'adresse IP que prendra le shield</span>
<span class="hljs-function">IPAddress <span class="hljs-title">ip</span><span class="hljs-params">(<span class="hljs-number">192</span>,<span class="hljs-number">168</span>,<span class="hljs-number">0</span>,<span class="hljs-number">143</span>)</span></span>;
<span class="hljs-comment">// L'objet qui nous servira a la communication</span>
EthernetClient client;
<span class="hljs-comment">// Le serveur à interroger</span>
<span class="hljs-keyword">char</span> serveur[] = <span class="hljs-string">"perdu.com"</span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// On démarre la voie série pour déboguer</span>
  Serial.begin(<span class="hljs-number">9600</span>);

  <span class="hljs-keyword">char</span> erreur = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// On démarre le shield Ethernet SANS adresse IP (donc donnée via DHCP)</span>
  erreur = Ethernet.begin(mac);

  <span class="hljs-keyword">if</span> (erreur == <span class="hljs-number">0</span>) {
    Serial.println(<span class="hljs-string">"Parametrage avec ip fixe..."</span>);
    <span class="hljs-comment">// si une erreur a eu lieu cela signifie que l'attribution DHCP</span>
    <span class="hljs-comment">// ne fonctionne pas. On initialise donc en forçant une IP</span>
    Ethernet.begin(mac, ip);
  }
  Serial.println(<span class="hljs-string">"Init..."</span>);
  <span class="hljs-comment">// Donne une seconde au shield pour s'initialiser</span>
  delay(<span class="hljs-number">1000</span>);
  Serial.println(<span class="hljs-string">"Pret !"</span>);
}
</code></pre>
</div>
<h4 id="envoyer-une-requête">
 <a aria-hidden="true" href="#envoyer-une-requête">
  <span class="es-autolink-heading">
  </span>
 </a>
 Envoyer une requête
</h4>
<p>
 Une fois que le shield est prêt, nous allons pouvoir commencer à l’utiliser ! Accrochez-vous, les choses amusantes commencent !
</p>
<h5 id="requête-simple">
 <a aria-hidden="true" href="#requête-simple">
  <span class="es-autolink-heading">
  </span>
 </a>
 Requête simple
</h5>
<p>
 Pour débuter, il va falloir générer une requête pour interroger un serveur dans l’espoir d’obtenir une réponse. Je vous propose de commencer par une chose simple, récupérer une page web très sommaire, celle de
 <a href="http://perdu.com">
  http://perdu.com
 </a>
 !
</p>
<p>
 C’est là que notre variable "client" de type
 <code>
  EthernetClient
 </code>
 entre enfin en jeu. C’est cette dernière qui va s’occuper des interactions avec la page. Nous allons utiliser sa méthode
 <code>
  connect()
 </code>
 pour aller nous connecter à un site puis ensuite nous ferons appel à sa méthode
 <code>
  println()
 </code>
 pour construire notre requête et l’envoyer.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// ... Initialisation précédente ...</span>

  <span class="hljs-comment">// On connecte notre Arduino sur "perdu.com" et le port 80 (defaut pour l'http)</span>
  erreur = client.connect(serveur, <span class="hljs-number">80</span>);

  <span class="hljs-keyword">if</span>(erreur == <span class="hljs-number">1</span>) {
      <span class="hljs-comment">// Pas d'erreur ? on continue !</span>
      Serial.println(<span class="hljs-string">"Connexion OK, envoi en cours..."</span>);

      <span class="hljs-comment">// On construit l'en-tête de la requête</span>
      client.println(<span class="hljs-string">"GET / HTTP/1.1"</span>);
      client.println(<span class="hljs-string">"Host: perdu.com"</span>);
      client.println(<span class="hljs-string">"Connection: close"</span>);
      client.println();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// La connexion a échoué :(</span>
    Serial.println(<span class="hljs-string">"Echec de la connexion"</span>);
    <span class="hljs-keyword">switch</span>(erreur) {
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-1</span>):
        Serial.println(<span class="hljs-string">"Time out"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-2</span>):
        Serial.println(<span class="hljs-string">"Serveur invalide"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-3</span>):
        Serial.println(<span class="hljs-string">"Tronque"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-4</span>):
        Serial.println(<span class="hljs-string">"Reponse invalide"</span>);
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// Problème = on bloque</span>
  }
}
</code></pre>
</div>
<p>
 Étudions un peu ces quelques lignes.
</p>
<p>
 Tout d’abord, on va essayer de connecter notre client au serveur de "perdu.com" sur son port 80 qui est le port par défaut du protocole HTTP :
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp">client.connect(<span class="hljs-string">"perdu.com"</span>, <span class="hljs-number">80</span>);
</code></pre>
</div>
<p>
 Ensuite, une fois que la connexion semble correcte, on va construire notre requête pas à pas.
Tout d’abord, on explique vouloir faire un
 <code>
  GET
 </code>
 sur la racine ("/") du site et le tout sous le protocole HTTP version 1.1.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp">client.println(<span class="hljs-string">"GET / HTTP/1.1"</span>);
</code></pre>
</div>
<p>
 Ensuite, on redéclare le site qui devra faire (héberger, "host" en anglais) la réponse. En l’occurrence on reste sur perdu.com.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp">client.println(<span class="hljs-string">"Host: perdu.com"</span>);
</code></pre>
</div>
<p>
 Puis, on signale au serveur que la connexion sera fermée lorsque les données sont transférées.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp">client.println(<span class="hljs-string">"Connection: close"</span>);
</code></pre>
</div>
<p>
 Enfin, pour prévenir que l’on vient de finir d’écrire notre en-tête (
 <em>
  header
 </em>
 ), on envoie une ligne blanche.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp">client.println();
</code></pre>
</div>
<p>
 J’ai ensuite rajouté un traitement des erreurs pour savoir ce qui se passe en cas de problème.
</p>
<h5 id="requête-avec-paramètre">
 <a aria-hidden="true" href="#requête-avec-paramètre">
  <span class="es-autolink-heading">
  </span>
 </a>
 Requête avec paramètre
</h5>
<p>
 Et si l’on voulait passer des informations complémentaires à la page ? Eh bien c’est simple, il suffira juste de modifier la requête GET en lui rajoutant les informations !
Par exemple, admettons que sur perdu.com il y ait une page de recherche "recherche.php" qui prenne un paramètre "m" comme mot-clé de recherche. On aurait alors :
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp">client.println(<span class="hljs-string">"GET /recherche.php?m=monmot HTTP/1.1"</span>);
</code></pre>
</div>
<p>
 Ce serait équivalent alors à aller demander la page "perdu.com/recherche.php?m=monmot", soit la page "recherche.php" avec comme argument de recherche "m" le mot "monmot".
</p>
<h4 id="lire-une-réponse">
 <a aria-hidden="true" href="#lire-une-réponse">
  <span class="es-autolink-heading">
  </span>
 </a>
 Lire une réponse
</h4>
<p>
 Lorsque la requête est envoyée (après le saut de ligne), le serveur va nous répondre en nous renvoyant la ressource demandée. En l’occurrence se sera la page d’accueil de perdu.com. Eh bien vous savez quoi ? On fera exactement comme avec une voie série. On commencera par regarder si des données sont arrivées, et si c’est le cas, on les lira une à une pour en faire ensuite ce que l’on veut (recomposer des lignes, chercher des choses dedans…)
</p>
<p>
 Dans l’immédiat, contentons-nous de tout afficher sur la voie série !
</p>
<p>
 Première étape, vérifier que nous avons bien reçu quelque chose. Pour cela, comme avec Serial, on va utiliser la méthode
 <code>
  available()
 </code>
 qui nous retourne le nombre de caractères disponibles à la lecture.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp">client.available()
</code></pre>
</div>
<p>
 Si des choses sont disponibles, on les lit une par une (comment ? Avec
 <code>
  read()
 </code>
 bien sûr !
 <img alt=":D" class="smiley" src="./static/smileys/heureux.png"/>
 ) et les envoie en même temps à la voie série :
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-keyword">char</span> carlu = <span class="hljs-number">0</span>;
<span class="hljs-comment">// on lit les caractères s'il y en a de disponibles</span>
<span class="hljs-keyword">if</span>(client.available()) {
  carlu = client.read();
  Serial.print(carlu);
}
</code></pre>
</div>
<p>
 Enfin, quand tout a été lu, on va vérifier l’état de notre connexion et fermer notre client si la connexion est terminée.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// Si on est bien déconnecté.</span>
<span class="hljs-keyword">if</span> (!client.connected()) {
  Serial.println();
  Serial.println(<span class="hljs-string">"Deconnexion !"</span>);
  <span class="hljs-comment">// On ferme le client</span>
  client.stop();
  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// On ne fait plus rien</span>
}
</code></pre>
</div>
<p>
 Globalement, voici le code pour lire une réponse :
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">char</span> carlu = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// on lit les caractères s'il y en a de disponibles</span>
  <span class="hljs-keyword">if</span>(client.available()) {
    carlu = client.read();
    Serial.print(carlu);
  }

  <span class="hljs-comment">// Si on est bien déconnecté.</span>
  <span class="hljs-keyword">if</span> (!client.connected()) {
    Serial.println();
    Serial.println(<span class="hljs-string">"Deconnexion !"</span>);
    <span class="hljs-comment">// On ferme le client</span>
    client.stop();
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// On ne fait plus rien</span>
  }
}
</code></pre>
</div>
<div class="custom-block alert alert-primary">
 <div class="custom-block-body">
  <p>
   Avez-vous remarqué, plutôt que de lire tous les caractères avec un
   <code>
    while
   </code>
   , on n’en lira qu’un seul à la fois par tour dans
   <code>
    loop()
   </code>
   . C’est un choix de design, avec un while cela marcherait aussi !
  </p>
 </div>
</div>
<h5 id="code-complet">
 <a aria-hidden="true" href="#code-complet">
  <span class="es-autolink-heading">
  </span>
 </a>
 Code complet
</h5>
<p>
 En résumé, voici le code complet de la lecture de la page "perdu.com"
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// Ces deux bibliothèques sont indispensables pour le shield</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Ethernet.h&gt;</span></span>

<span class="hljs-comment">// L'adresse MAC du shield</span>
byte mac[] = { <span class="hljs-number">0x90</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x0E</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0x7E</span> };
<span class="hljs-comment">// L'adresse IP que prendra le shield</span>
<span class="hljs-function">IPAddress <span class="hljs-title">ip</span><span class="hljs-params">(<span class="hljs-number">192</span>,<span class="hljs-number">168</span>,<span class="hljs-number">0</span>,<span class="hljs-number">143</span>)</span></span>;
<span class="hljs-comment">// L'objet qui nous servira à la communication</span>
EthernetClient client;
<span class="hljs-comment">// Le serveur à interroger</span>
<span class="hljs-keyword">char</span> serveur[] = <span class="hljs-string">"perdu.com"</span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// On démarre la voie série pour déboguer</span>
  Serial.begin(<span class="hljs-number">9600</span>);

  <span class="hljs-keyword">char</span> erreur = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// On démarre le shield Ethernet SANS adresse IP (donc donnée via DHCP)</span>
  erreur = Ethernet.begin(mac);

  <span class="hljs-keyword">if</span> (erreur == <span class="hljs-number">0</span>) {
    Serial.println(<span class="hljs-string">"Parametrage avec ip fixe..."</span>);
    <span class="hljs-comment">// si une erreur a eu lieu cela signifie que l'attribution DHCP</span>
    <span class="hljs-comment">// ne fonctionne pas. On initialise donc en forçant une IP</span>
    Ethernet.begin(mac, ip);
  }
  Serial.println(<span class="hljs-string">"Init..."</span>);
  <span class="hljs-comment">// Donne une seconde au shield pour s'initialiser</span>
  delay(<span class="hljs-number">1000</span>);
  Serial.println(<span class="hljs-string">"Pret !"</span>);

  <span class="hljs-comment">// On connecte notre Arduino sur "perdu.com" et le port 80 (defaut pour l'http)</span>
  erreur = client.connect(serveur, <span class="hljs-number">80</span>);

  <span class="hljs-keyword">if</span>(erreur == <span class="hljs-number">1</span>) {
      <span class="hljs-comment">// Pas d'erreur ? on continue !</span>
      Serial.println(<span class="hljs-string">"Connexion OK, envoi en cours..."</span>);

      <span class="hljs-comment">// On construit l'en-tête de la requête</span>
      client.println(<span class="hljs-string">"GET / HTTP/1.1"</span>);
      client.println(<span class="hljs-string">"Host: perdu.com"</span>);
      client.println(<span class="hljs-string">"Connection: close"</span>);
      client.println();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// La connexion a échoué :(</span>
    Serial.println(<span class="hljs-string">"Echec de la connexion"</span>);
    <span class="hljs-keyword">switch</span>(erreur) {
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-1</span>):
        Serial.println(<span class="hljs-string">"Time out"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-2</span>):
        Serial.println(<span class="hljs-string">"Serveur invalide"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-3</span>):
        Serial.println(<span class="hljs-string">"Tronque"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-4</span>):
        Serial.println(<span class="hljs-string">"Reponse invalide"</span>);
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// On bloque la suite</span>
  }
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">char</span> carlu = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// on lit les caractères s'il y en a de disponibles</span>
  <span class="hljs-keyword">if</span>(client.available()) {
    carlu = client.read();
    Serial.print(carlu);
  }

  <span class="hljs-comment">// Si on est bien déconnecté.</span>
  <span class="hljs-keyword">if</span> (!client.connected()) {
    Serial.println();
    Serial.println(<span class="hljs-string">"Deconnexion !"</span>);
    <span class="hljs-comment">// On ferme le client</span>
    client.stop();
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// On ne fait plus rien</span>
  }
}
</code></pre>
</div>
<p>
 Et voici le résultat que vous devez obtenir dans votre terminal série. Remarquez la présence du header de la réponse que l’on reçoit.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-text">HTTP/1.1 200 OK
Date: Thu, 26 Mar 2015 16:14:15 GMT
Server: Apache
Last-Modified: Tue, 02 Mar 2010 18:52:21 GMT
ETag: "cc-480d5dd98a340"
Accept-Ranges: bytes
Content-Length: 204
Vary: Accept-Encoding
Connection: close
Content-Type: text/html

&lt;html&gt;&lt;head&gt;&lt;title&gt;Vous Etes Perdu ?&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Perdu sur l'Internet ?&lt;/h1&gt;&lt;h2&gt;Pas de panique, on va vous aider&lt;/h2&gt;&lt;strong&gt;&lt;pre&gt;    * &lt;----- vous &amp;ecirc;tes ici&lt;/pre&gt;&lt;/strong&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>
</div>
<h4 id="faire-des-requêtes-en-continu">
 <a aria-hidden="true" href="#faire-des-requêtes-en-continu">
  <span class="es-autolink-heading">
  </span>
 </a>
 Faire des requêtes en continu
</h4>
<p>
 Faire une requête en début de programme c’est bien, mais ce serait mieux de pouvoir la faire quand on veut. Faire évoluer notre programme ne va pourtant pas être si simple…
</p>
<p>
 Pour commencer, on va ajouter quelques nouvelles variables. La première servira à se souvenir de quand date (via
 <code>
  millis()
 </code>
 ) la dernière requête faite. Ce sera donc un
 <code>
  long()
 </code>
 . La seconde sera une constante servant à indiquer le temps minimal devant s’écouler entre deux requêtes. Enfin, la dernière variable sera un booléen servant de
 <em>
  flag
 </em>
 pour indiquer l’état de la connexion (ouverte ou fermée) entre deux tours de boucle
 <code>
  loop()
 </code>
 .
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// moment de la dernière requête</span>
<span class="hljs-keyword">long</span> derniereRequete = <span class="hljs-number">0</span>;
<span class="hljs-comment">// temps minimum entre deux requêtes</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">long</span> updateInterval = <span class="hljs-number">10000</span>;
<span class="hljs-comment">// mémorise l'état de la connexion entre deux tours de loop</span>
<span class="hljs-keyword">bool</span> etaitConnecte = <span class="hljs-literal">false</span>;
</code></pre>
</div>
<p>
 Ensuite, on va créer une fonction sobrement nommée
 <code>
  requete()
 </code>
 qui se chargera de construire et envoyer la requête. Aucune nouveauté là-dedans, c’est le code que vous connaissez déjà.
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">requete</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// On connecte notre Arduino sur "perdu.com" et le port 80 (defaut pour l'http)</span>
  <span class="hljs-keyword">char</span> erreur = client.connect(serveur, <span class="hljs-number">80</span>);

  <span class="hljs-keyword">if</span>(erreur == <span class="hljs-number">1</span>) {
      <span class="hljs-comment">// Pas d'erreur ? on continue !</span>
      Serial.println(<span class="hljs-string">"Connexion OK, envoi en cours..."</span>);

      <span class="hljs-comment">// On construit l'en-tête de la requête</span>
      client.println(<span class="hljs-string">"GET / HTTP/1.1"</span>);
      client.println(<span class="hljs-string">"Host: perdu.com"</span>);
      client.println(<span class="hljs-string">"Connection: close"</span>);
      client.println();

      <span class="hljs-comment">// On enregistre le moment d'envoi de la dernière requête</span>
      derniereRequete = millis();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// La connexion a échoué :(</span>
    <span class="hljs-comment">// On ferme notre client</span>
    client.stop();
    <span class="hljs-comment">// On avertit l'utilisateur</span>
    Serial.println(<span class="hljs-string">"Echec de la connexion"</span>);
    <span class="hljs-keyword">switch</span>(erreur) {
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-1</span>):
        Serial.println(<span class="hljs-string">"Time out"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-2</span>):
        Serial.println(<span class="hljs-string">"Serveur invalide"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-3</span>):
        Serial.println(<span class="hljs-string">"Tronque"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-4</span>):
        Serial.println(<span class="hljs-string">"Reponse invalide"</span>);
        <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
</div>
<p>
 La seule différence ici est que l’on ferme le client si la connexion a un problème et aussi on enregistre le moment auquel a été faite la requête.
</p>
<p>
 Bien. Maintenant, il faut revoir notre loop.
</p>
<p>
 Le début ne change pas, on récupère/affiche les caractères s’ils sont disponibles.
</p>
<p>
 Ensuite, on avait l’étape de fermeture du client si la connexion est fermée. Dans notre cas actuel, on ne doit pas l’arrêter n’importe quand, car sinon une connexion pourrait de nouveau avoir lieu sans que celle-là soit finie. On va donc la fermer QUE si elle était déjà fermée à la toute fin du tour précédent. Voici comme cela peut-être représenté :
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">// traite les caractères</span>
  <span class="hljs-comment">// ...</span>

  <span class="hljs-comment">// SI on était connecté au tour précédent</span>
  <span class="hljs-comment">// ET que maintenant on est plus connecté</span>
  <span class="hljs-comment">// ALORS on ferme la connexion</span>
  <span class="hljs-keyword">if</span> (etaitConnecte &amp;&amp; !client.connected()) {
    Serial.println();
    Serial.println(<span class="hljs-string">"Deconnexion !"</span>);
    <span class="hljs-comment">// On ferme le client</span>
    client.stop();
  }

  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// bricole, traite, calcul, manigance, complote...</span>
  <span class="hljs-comment">// ...</span>

  <span class="hljs-comment">// enregistre l’état de la connexion (ouvert ou fermé)</span>
  etaitConnecte = client.connected();
}
</code></pre>
</div>
<p>
 Maintenant, il ne nous reste plus qu’à redéclencher une requête si nos dix secondes se sont écoulées et que la précédente connexion a fini de travailler :
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// Si on est déconnecté</span>
<span class="hljs-comment">// et que cela fait plus de xx secondes qu'on a pas fait de requête</span>
<span class="hljs-keyword">if</span>(!client.connected() &amp;&amp; ((millis() - derniereRequete) &gt; updateInterval)) {
  requete();
}
</code></pre>
</div>
<p>
 C’est tout clair ? Ci-dessous le code complet pour vous aider à y voir un peu mieux dans l’ensemble
 <img alt=";)" class="smiley" src="./static/smileys/clin.png"/>
 .
</p>
<h5 id="le-code-complet">
 <a aria-hidden="true" href="#le-code-complet">
  <span class="es-autolink-heading">
  </span>
 </a>
 Le code complet
</h5>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// Ces deux bibliothèques sont indispensables pour le shield</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Ethernet.h&gt;</span></span>

<span class="hljs-comment">// L'adresse MAC du shield</span>
byte mac[] = { <span class="hljs-number">0x90</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x0E</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0x7E</span> };
<span class="hljs-comment">// L'adresse IP que prendra le shield</span>
<span class="hljs-function">IPAddress <span class="hljs-title">ip</span><span class="hljs-params">(<span class="hljs-number">192</span>,<span class="hljs-number">168</span>,<span class="hljs-number">0</span>,<span class="hljs-number">143</span>)</span></span>;
<span class="hljs-comment">// L'objet qui nous servira a la communication</span>
EthernetClient client;
<span class="hljs-comment">// Le serveur à interroger</span>
<span class="hljs-keyword">char</span> serveur[] = <span class="hljs-string">"perdu.com"</span>;

<span class="hljs-comment">// pour lire les caractères</span>
<span class="hljs-keyword">char</span> carlu = <span class="hljs-number">0</span>;
<span class="hljs-comment">// moment de la dernière requête</span>
<span class="hljs-keyword">long</span> derniereRequete = <span class="hljs-number">0</span>;
<span class="hljs-comment">// temps minimum entre deux requêtes</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">long</span> updateInterval = <span class="hljs-number">10000</span>;
<span class="hljs-comment">// mémorise l'état de la connexion entre deux tours de loop</span>
<span class="hljs-keyword">bool</span> etaitConnecte = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// On démarre la voie série pour déboguer</span>
  Serial.begin(<span class="hljs-number">9600</span>);

  <span class="hljs-keyword">char</span> erreur = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// On démarre le shield Ethernet SANS adresse IP (donc donnée via DHCP)</span>
  erreur = Ethernet.begin(mac);

  <span class="hljs-keyword">if</span> (erreur == <span class="hljs-number">0</span>) {
    Serial.println(<span class="hljs-string">"Parametrage avec ip fixe..."</span>);
    <span class="hljs-comment">// si une erreur a eu lieu cela signifie que l'attribution DHCP</span>
    <span class="hljs-comment">// ne fonctionne pas. On initialise donc en forçant une IP</span>
    Ethernet.begin(mac, ip);
  }
  Serial.println(<span class="hljs-string">"Init..."</span>);
  <span class="hljs-comment">// Donne une seconde au shield pour s'initialiser</span>
  delay(<span class="hljs-number">1000</span>);
  Serial.println(<span class="hljs-string">"Pret !"</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">// on lit les caractères s'il y en a de disponibles</span>
  <span class="hljs-keyword">if</span>(client.available()) {
    carlu = client.read();
    Serial.print(carlu);
  }

  <span class="hljs-comment">// SI on était connecté au tour précédent</span>
  <span class="hljs-comment">// ET que maintenant on est plus connecté</span>
  <span class="hljs-comment">// ALORS on ferme la connexion</span>
  <span class="hljs-keyword">if</span> (etaitConnecte &amp;&amp; !client.connected()) {
    Serial.println();
    Serial.println(<span class="hljs-string">"Deconnexion !"</span>);
    <span class="hljs-comment">// On ferme le client</span>
    client.stop();
  }

  <span class="hljs-comment">// Si on est déconnecté</span>
  <span class="hljs-comment">// et que cela fait plus de xx secondes qu'on a pas fait de requête</span>
  <span class="hljs-keyword">if</span>(!client.connected() &amp;&amp; ((millis() - derniereRequete) &gt; updateInterval)) {
    requete();
  }

  <span class="hljs-comment">// enregistre l'état de la connexion (ouvert ou fermé)</span>
  etaitConnecte = client.connected();
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">requete</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// On connecte notre Arduino sur "perdu.com" et le port 80 (defaut pour l'http)</span>
  <span class="hljs-keyword">char</span> erreur = client.connect(serveur, <span class="hljs-number">80</span>);

  <span class="hljs-keyword">if</span>(erreur == <span class="hljs-number">1</span>) {
      <span class="hljs-comment">// Pas d'erreur ? on continue !</span>
      Serial.println(<span class="hljs-string">"Connexion OK, envoi en cours..."</span>);

      <span class="hljs-comment">// On construit l'en-tête de la requête</span>
      client.println(<span class="hljs-string">"GET / HTTP/1.1"</span>);
      client.println(<span class="hljs-string">"Host: perdu.com"</span>);
      client.println(<span class="hljs-string">"Connection: close"</span>);
      client.println();

      <span class="hljs-comment">// On enregistre le moment d'envoi de la dernière requête</span>
      derniereRequete = millis();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// La connexion a échoué :(</span>
    <span class="hljs-comment">// On ferme notre client</span>
    client.stop();
    <span class="hljs-comment">// On avertit l'utilisateur</span>
    Serial.println(<span class="hljs-string">"Echec de la connexion"</span>);
    <span class="hljs-keyword">switch</span>(erreur) {
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-1</span>):
        Serial.println(<span class="hljs-string">"Time out"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-2</span>):
        Serial.println(<span class="hljs-string">"Serveur invalide"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-3</span>):
        Serial.println(<span class="hljs-string">"Tronque"</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span>(<span class="hljs-number">-4</span>):
        Serial.println(<span class="hljs-string">"Reponse invalide"</span>);
        <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
</div>
<h4 id="lintérêt-dun-client">
 <a aria-hidden="true" href="#lintérêt-dun-client">
  <span class="es-autolink-heading">
  </span>
 </a>
 L’intérêt d’un client
</h4>
<p>
 En lisant tout ça, vous vous dites peut-être qu’utiliser le shield Ethernet en mode client est un peu inutile. C’est vrai, après tout on ne peut même pas afficher les pages reçues !
</p>
<p>
 Cependant, avec un peu d’imagination on pourrait facilement voir des utilisations plus que pratiques !
</p>
<h5 id="télécharger-une-configuration">
 <a aria-hidden="true" href="#télécharger-une-configuration">
  <span class="es-autolink-heading">
  </span>
 </a>
 Télécharger une configuration
</h5>
<p>
 La première idée par exemple pourrait être de mettre à disposition des fichiers de paramètres à l’Arduino. Imaginons par exemple que je fais une application qui dépend des saisons. Mon application pourrait utiliser des moteurs et des capteurs pour faire certaines actions, mais ces dernières pourraient être différentes en fonction du moment de l’année. Plutôt que de stocker 4 ensembles de paramètres dans l’Arduino, cette dernière pourrait vérifier régulièrement en ligne (en interrogeant un petit script que nous aurions fait) pour savoir si quelque chose doit changer. Et voilà, configuration à distance !
</p>
<h5 id="enregistrer-des-données-en-ligne">
 <a aria-hidden="true" href="#enregistrer-des-données-en-ligne">
  <span class="es-autolink-heading">
  </span>
 </a>
 Enregistrer des données en ligne
</h5>
<p>
 J’ai souvent lu sur des forums que des gens aimeraient pouvoir sauvegarder des choses dans une base de données. Bien entendu, l’Arduino seule ne peut pas le faire, gérer une BDD est bien trop compliqué pour elle. En revanche, elle pourrait facilement interroger des pages en insérant des paramètres dans sa requête. La page qui reçoit alors la requête lirait ce paramètre et s’occuperait de sauvegarder les infos.
Par exemple, on pourrait imaginer la requête
 <code>
  http://mapageweb.com/enregistrer.php?&amp;analog1=123&amp;analog2=28&amp;millis=123456
 </code>
 . Cette requête possède deux paramètres,
 <strong>
  analog1
 </strong>
 et
 <strong>
  analog2
 </strong>
 qui pourraient être les valeurs des entrées analogiques et un dernier "millis" qui pourrait être la valeur de millis() d’Arduino. Notre page "enregistrer.php" ferait alors la sauvegarde dans sa base de données !
Pour construire une telle requête, le code suivant devrait faire l’affaire :
</p>
<div class="hljs-code-div">
 <div class="hljs-line-numbers">
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
  <span>
  </span>
 </div>
 <pre><code class="hljs language-cpp"><span class="hljs-comment">// On construit l'en-tête de la requête</span>
client.print(<span class="hljs-string">"GET /enregistrer.php/?analog1="</span>); <span class="hljs-comment">//attention, pas de saut de ligne !</span>
client.print(analogRead(A1));
client.print(<span class="hljs-string">"&amp;analog2="</span>);
client.print(analogRead(A2));
client.print(<span class="hljs-string">"&amp;millis="</span>);
client.print(millis());
<span class="hljs-comment">// On finit par le protocole</span>
client.println(<span class="hljs-string">" HTTP/1.1"</span>); <span class="hljs-comment">//ce coup-ci, saut de ligne pour valider !</span>
<span class="hljs-comment">// on aurait alors :</span>
<span class="hljs-comment">// "GET /enregistrer.php/?analog1=&lt;valeur-de-A1&gt;&amp;analog2=&lt;valeur-de-A2&gt;&amp;millis=&lt;valeur-de-millis()&gt; HTTP/1.1"</span>
client.println(<span class="hljs-string">"Host: mapageweb.com"</span>);
client.println(<span class="hljs-string">"Connection: close"</span>);
client.println();
</code></pre>
</div>
<h5 id="sûrement-plein-dautres-choses">
 <a aria-hidden="true" href="#sûrement-plein-dautres-choses">
  <span class="es-autolink-heading">
  </span>
 </a>
 Sûrement plein d’autres choses !
</h5>
<p>
 Il existe surement un paquet d’autres idées auquel je n’ai pas pensé !
</p>
<h3 id="exercice-lire-luptime-de-eskimonfr">
 <a aria-hidden="true" href="#exercice-lire-luptime-de-eskimonfr">
  <span class="es-autolink-heading">
  </span>
 </a>
 Exercice, lire l’uptime de Eskimon.fr
</h3>
<p>
 Pour finir ce chapitre je vous propose un petit exercice, allez lire l’uptime (temps écoulé depuis la mise en route du système) de mon blog, eskimon.fr.
</p>
<h4 id="consigne">
 <a aria-hidden="true" href="#consigne">
  <span class="es-autolink-heading">
  </span>
 </a>
 Consigne
</h4>
<p>
 Pour cela, je vous ai concocté une petite page juste pour vous qui renvoie uniquement cette information, sans tout le bazar HTTP qui va avec une page classique. Vous obtiendrez ainsi simplement le header de la requête et la valeur brute de l’uptime.
</p>
<p>
 La page à interroger pour votre requête est :
 <code>
  http://eskimon.fr/public/arduino.php
 </code>
</p>
<p>
 Essayer de modifier votre code pour afficher cette information
 <img alt=";)" class="smiley" src="./static/smileys/clin.png"/>
</p>
<p>
 Vous êtes maintenant en mesure de vous balader sur Internet pour aller y chercher des informations. Bienvenue dans l’IoT, l’Internet of Things !
</p>
            </div>
            <!-- /.entry-content -->
            <hr>
            <div class="row bg-light my-2 py-2 rounded">
                <div class="col mr-auto">
                    <a class="" href="/tuto-arduino-801-découverte-de-lethernet-sur-arduino" rel="prev">
                        <i class="fas fa-chevron-left fa-lg"></i>
                        tuto-arduino-801-découverte-de-lethernet-sur-arduino
                    </a>
                </div>
                <div class="col-auto">
                    <a class="" href="/tuto-arduino-803-arduino-et-ethernet-serveur" rel="next">
                        tuto-arduino-803-arduino-et-ethernet-serveur
                        <i class="fas fa-chevron-right fa-lg"></i>
                    </a>
                </div>
            </div>
            <div class="text-center">
                <img class="es-licence-pic" src="/static/images/CC BY-NC-SA.png" alt="Licence CC BY-NC-SA" title="Article sous licence CC BY-NC-SA">
            </div>
            <div class="my-3 text-center">
                <a class="btn btn-outline-dark mx-1" href="https://twitter.com/share?url=https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client&amp;text=Arduino et Ethernet : client - https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client" rel="nofollow" title="Partager cet article sur Twitter" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-twitter fa-lg"></i>
                </a>
                <a class="btn btn-outline-dark mx-1" href="https://www.facebook.com/sharer.php?u=https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client&amp;t=Arduino et Ethernet : client - https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client" rel="nofollow" title="Partager cet article sur Facebook" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-facebook-f fa-lg"></i>
                </a>
                <a class="btn btn-outline-dark mx-1" href="https://plus.google.com/share?url=https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client&amp;hl=fr" rel="nofollow" title="Partager cet article sur Google +" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-google-plus fa-lg"></i>
                </a>
                <!--<a class="btn btn-outline-dark mx-1" href="http://sharetodiaspora.github.io/?url=https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client&amp;title=Arduino et Ethernet : client - https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client" rel="nofollow"  title="Partager cet article sur Diaspora" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="fab fa-google-plus fa-lg"></i>
                </a>-->
                <a class="btn btn-outline-dark mx-1" href="mailto:?subject=Arduino et Ethernet : client&amp;body=https://eskimon.fr/tuto-arduino-802-arduino-et-ethernet-client"rel="nofollow" title="Partager cet article par email" role="button" data-toggle="tooltip" data-placement="top">
                    <i class="far fa-envelope fa-lg"></i>
                </a>
            </div>
            <hr>
            <div class="text-center">
                <!-- billboard horizontal fin article -->
                <ins class="adsbygoogle" style="display:inline-block;width:970px;height:250px" data-ad-client="ca-pub-2080155902357792" data-ad-slot="6471099302"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
            <div class="text-center">
                <p>Vous avez une question ? Vous souhaitez partager votre experience ? Venez nous rejoindre sur Discord !</p>
                <iframe src="https://discordapp.com/widget?id=550632131877928960&theme=dark" width="500" height="500" allowtransparency="true" frameborder="0"></iframe>
            </div>
        </article>
    </div>
    <div class="d-none d-xl-block col-xl-1 offset-xl-1 px-0">
        <!-- Pub ajouté auto -->
        <!--
        <div class="d-flex flex-column justify-content-around align-items-end h-100" id="es-right-ad-block">
        </div>
        -->
    </div>
</div>
    </div>
<footer class="container-fluid bg-dark small text-white px-3">
<div class="row">
    <div class="col align-self-center">
        © Eskimon -
        Blog propulsé par <a class="bold text-white" href="https://blog.getpelican.com/" rel="nofollow">Pelican</a> -
        Thème fait maison
    </div>
    <div class="col align-self-end text-right">
        <a class="btn btn-lg text-light" href="https://github.com/Eskimon" rel="nofollow" title="Mon profil Github">
            <i class="fab fa-github fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://twitter.com/Eskimon_fr" rel="nofollow" title="Me suivre sur Twitter">
            <i class="fab fa-twitter fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://twitch.tv/eskimon" rel="nofollow" title="Me suivre sur Twitch">
            <i class="fab fa-twitch fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://www.youtube.com/user/Eskimon49/featured" rel="nofollow" title="Les VOD sur Youtube">
            <i class="fab fa-youtube fa-lg"></i>
        </a>
        <a class="btn btn-lg text-light" href="https://discord.gg/9SkDWft" rel="nofollow" title="Venez participer sur Discord">
            <i class="fab fa-discord fa-lg"></i>
        </a>
    </div>
  </div>
</footer>
    <!-- For formula -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- Font awesome -->
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
    <!-- JQuery first -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- For tooltips -->
    <script>$(function () {  $('[data-toggle="tooltip"]').tooltip()})</script>
    <script src="/static/js/my-scripts.js"></script>
<script>
function create_side_summary() {
    // Duplicate summary
    var main_summary = $('#sommaire').next();
    if(main_summary.length === 0)
        return
    var side_summary = main_summary.clone();
    side_summary.addClass('pl-0');
    var all_p = side_summary.find('p');
    all_p.contents().unwrap();
    var all_li = side_summary.find('li');
    all_li.addClass('pl-1');

    // scrollspy - in
    side_summary.attr('id', 'es-side-summary-mainlist');
    //side_summary.addClass('nav');
    //all_li.addClass('nav-item');
    var all_a = side_summary.find('a');
    all_a.addClass('nav-link');
    var all_ul = side_summary.find('ul');
    all_ul.addClass('pl-1');
    $('body').scrollspy({ target: '#es-side-summary-mainlist' });
    // scrollspy - out

    var summary_title = document.createElement("h4");
    summary_title.className = 'navbar-brand';
    summary_title.innerHTML = 'Sommaire';
    $(summary_title).prependTo('#es-side-summary-content');
    side_summary.appendTo('#es-side-summary-content');
    main_summary.addClass('es-subul-collapse');
}

function generate_spoilers() {
    all_secret = $('.custom-block-spoiler');
    all_secret.each(function( index ) {
        let content = $(this).html();
        $(this).html('');
        $(this).addClass('card');
        var headerText = document.createElement("button");
        var cardHeader = document.createElement("div");
        var cardBodyWrapper = document.createElement("div");
        var cardBody = document.createElement("div");
        $(headerText).text('Contenu masqué, cliquez pour afficher');
        $(headerText).addClass('btn btn-link btn-sm');
        $(headerText).attr('data-toggle', 'collapse');
        $(headerText).attr('data-target', '#collapse-' + index);
        $(headerText).attr('aria-controls', 'collapse-' + index);
        $(headerText).attr('aria-expanded', 'false');
        $(cardHeader).append(headerText);
        $(cardHeader).addClass('card-header');
        $(cardHeader).attr('id', 'spoiler-' + index);
        $(cardBody).html(content);
        $(cardBody).addClass('card-body');
        $(cardBodyWrapper).append(cardBody);
        $(cardBodyWrapper).addClass('collapse hide');
        $(cardBodyWrapper).attr('id', 'collapse-' + index)
        $(cardBodyWrapper).attr('aria-labelledby', 'spoiler-' + index)
        $(this).prepend(cardHeader);
        $(this).append(cardBodyWrapper);
    });

    $('.collapse').collapse({toggle: false});
}

function load_extra_ads() {
    return;
    // Load right side blocks
    var sidebar = $('#es-right-ad-block');
    var n_height = Math.floor(sidebar.height() / 2000);
    for (i = 0; i < n_height; i++) {
        var frag = document.createDocumentFragment();
        var newAdBlock = document.createElement("div");
        var block1 = document.createElement("ins");
        var block2 = document.createElement("script");

        block1.innerHTML = '<ins class="adsbygoogle" ' +
            'style="display:inline-block;width:120px;height:600px" ' +
            'data-ad-client="ca-pub-2080155902357792" ' +
            'data-ad-slot="4023722026"></ins>';
        block2.innerHTML = '(adsbygoogle = window.adsbygoogle || []).push({});';

        $(newAdBlock).append(block1);
        $(newAdBlock).append(block2);
        $(frag).append(newAdBlock);

        $(sidebar).append(frag);
    }

    // Load in feed blocks (above every h3)
    var frag = document.createDocumentFragment();
    var newAdBlock = document.createElement("div");
    var block1 = document.createElement("ins");
    var block2 = document.createElement("script");
    block1.innerHTML = '<ins class="adsbygoogle"' +
    'style = "display:inline-block;width:970px;height:90px"' +
    'data - ad - client="ca-pub-2080155902357792"' +
    'data - ad - slot="7100712740" ></ins >'
    block2.innerHTML = '(adsbygoogle = window.adsbygoogle || []).push({});';
    $(newAdBlock).append(block1);
    $(newAdBlock).append(block2);
    newAdBlock.className = 'my-3 text-center';
    $(frag).append(newAdBlock);
    var titles = $('.entry-content h3').slice(1);
    $(frag).insertBefore(titles);
}

function load_top_moneytizer_ads() {
    var frag = document.createDocumentFragment();
    var newAdBlock = document.createElement("div");
    var script1 = document.createElement("script");
    var script2 = document.createElement("script");
    script1.src = "//ads.themoneytizer.com/s/gen.js?type=1";
    script2.src = "//ads.themoneytizer.com/s/requestform.js?siteId=70220&formatId=1";
    newAdBlock.id = '70220-1';
    newAdBlock.append(script1);
    newAdBlock.append(script2);
    $(frag).append(newAdBlock);
    $(frag).insertBefore($('.entry-content h3')[1]);
}

$(document).ready(function () {
    create_side_summary();
    generate_spoilers();
    load_extra_ads();

    // when opening the sidebar
    $('#sidebarCollapse').on('click', function () {
        // open sidebar
        $('#es-side-summary').removeClass('d-none');
        $('#es-content').addClass('d-none');
        $('#sidebarCollapse').removeClass('sticky-top');
    });

    // if dismiss or overlay was clicked
    $('#es-side-summary').on('click', function () {
      // hide the sidebar
      $('#es-side-summary').addClass('d-none');
      $('#es-content').removeClass('d-none');
      $('#sidebarCollapse').addClass('sticky-top');
    });
});
</script>

</body>

</html>